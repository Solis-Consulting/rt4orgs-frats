<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>RT4 Lead Console</title>
  <style>
    body { font-family: -apple-system, system-ui, sans-serif; margin: 0; background: #0f172a; color: #e5e7eb; }
    .shell { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    .card { background: #020617; border-radius: 16px; padding: 20px 24px; box-shadow: 0 18px 60px rgba(0,0,0,0.6); border: 1px solid #1f2937; }
    h1 { margin: 0 0 8px; font-size: 24px; }
    .sub { margin-bottom: 16px; color: #9ca3af; font-size: 14px; }
    .toolbar { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
    input, select { background: #020617; border: 1px solid #4b5563; border-radius: 8px; padding: 6px 10px; color: #e5e7eb; font-size: 13px; }
    input:focus, select:focus { outline: none; border-color: #38bdf8; }
    .pill-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .pill { font-size: 11px; padding: 4px 10px; border-radius: 999px; border: 1px solid #374151; cursor: pointer; color: #9ca3af; }
    .pill.active { background: #0ea5e9; border-color: #0ea5e9; color: #0f172a; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 8px; }
    th, td { padding: 8px 6px; text-align: left; border-bottom: 1px solid #1f2937; }
    th { font-size: 11px; text-transform: uppercase; letter-spacing: 0.06em; color: #6b7280; }
    tr:hover td { background: #020617; }
    .badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 999px; font-size: 11px; }
    .badge.green { background: rgba(34,197,94,0.15); color: #bbf7d0; }
    .badge.red { background: rgba(248,113,113,0.15); color: #fecaca; }
    .badge.amber { background: rgba(245,158,11,0.15); color: #fed7aa; }
    .badge.gray { background: rgba(75,85,99,0.4); color: #e5e7eb; }
    .badge.person { background: rgba(59,130,246,0.15); color: #bfdbfe; }
    .badge.fraternity { background: rgba(168,85,247,0.15); color: #e9d5ff; }
    .badge.team { background: rgba(34,197,94,0.15); color: #bbf7d0; }
    .badge.business { background: rgba(245,158,11,0.15); color: #fed7aa; }
    .link { color: #38bdf8; text-decoration: none; font-weight: 500; }
    .link:hover { text-decoration: underline; }
    .meta { display: flex; gap: 16px; font-size: 12px; color: #9ca3af; margin-bottom: 8px; }
    .meta strong { color: #e5e7eb; }
    .tabs { display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 1px solid #1f2937; }
    .tab { padding: 8px 16px; cursor: pointer; color: #9ca3af; border-bottom: 2px solid transparent; }
    .tab.active { color: #38bdf8; border-bottom-color: #38bdf8; }
    button { background: #0ea5e9; color: #0f172a; border: none; border-radius: 8px; padding: 6px 12px; font-size: 13px; font-weight: 600; cursor: pointer; }
    button:hover { background: #38bdf8; }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card">
      <h1>RT4 Lead Console</h1>
      <div class="sub">Live state view of all current conversations and cards.</div>

      <div class="tabs">
        <div class="tab active" data-view="leads">Leads</div>
        <div class="tab" data-view="cards">Cards</div>
        <div style="flex: 1;"></div>
        <a href="upload.html" class="link" style="padding: 8px 0;">Upload Cards</a>
      </div>

      <!-- Leads View -->
      <div id="leadsView">
        <div class="toolbar">
          <input id="search" placeholder="Search by name or phone">
          <select id="stateFilter">
            <option value="all">All states</option>
            <option value="active">Active (not dead/not_interested/no_time)</option>
            <option value="initial_outreach">Initial outreach only</option>
          </select>
        </div>

      <div class="pill-row">
        <div class="pill active" data-sort="state">Sort by state</div>
        <div class="pill" data-sort="name">Sort by name</div>
        <div class="pill" data-sort="folders_desc">Sort by folders</div>
      </div>

        <div class="meta" id="summary"></div>
        <div id="tableWrap"></div>
      </div>

      <!-- Cards View -->
      <div id="cardsView" style="display: none;">
        <div class="toolbar">
          <input id="cardSearch" placeholder="Search by name or ID">
          <select id="cardTypeFilter">
            <option value="">All types</option>
            <option value="person">Person</option>
            <option value="fraternity">Fraternity</option>
            <option value="team">Team</option>
            <option value="business">Business</option>
          </select>
          <select id="cardStateFilter">
            <option value="">All sales states</option>
            <option value="cold">Cold</option>
            <option value="qualified">Qualified</option>
            <option value="negotiating">Negotiating</option>
            <option value="won">Won</option>
            <option value="lost">Lost</option>
          </select>
        </div>
        <div class="meta" id="cardSummary"></div>
        <div id="cardTableWrap"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { BACKEND_URL } from '/config.js';
    const BACKEND = BACKEND_URL;
    let allLeads = [];
    let allCards = [];
    let currentSort = "state";
    let currentView = "leads";

    function stateBadgeClass(s) {
      if (!s) return "gray";
      const v = s.toLowerCase();
      if (v.includes("ready") || v.includes("pay")) return "green";
      if (v.includes("dead") || v.includes("not_interested") || v.includes("no_time")) return "red";
      if (v.includes("question") || v.includes("who_are_you") || v.includes("waiting")) return "amber";
      if (v.includes("initial_outreach")) return "gray";
      return "amber";
    }

    function sortLeads(leads, mode) {
      if (mode === "name") {
        leads.sort((a, b) => a.name.localeCompare(b.name));
      } else if (mode === "folders_desc") {
        leads.sort((a, b) => b.folders.length - a.folders.length);
      } else {
        leads.sort((a, b) => {
          const s1 = a.latest_state?.next_state || "";
          const s2 = b.latest_state?.next_state || "";
          if (s1 === "initial_outreach" && s2 !== "initial_outreach") return 1;
          if (s2 === "initial_outreach" && s1 !== "initial_outreach") return -1;
          return s1 < s2 ? 1 : -1;
        });
      }
    }

    function render() {
      const search = document.getElementById("search").value.toLowerCase();
      const filter = document.getElementById("stateFilter").value;

      let rows = allLeads.slice();

      sortLeads(rows, currentSort);

      rows = rows.filter(l => {
        const s = l.latest_state?.next_state || "";
        if (filter === "active") {
          const v = s.toLowerCase();
          if (v.includes("dead") || v.includes("not_interested") || v.includes("no_time") || v.includes("initial_outreach")) return false;
        }
        if (filter === "initial_outreach" && s !== "initial_outreach") return false;
        if (!search) return true;
        const phone = l.folders[0]?.state?.raw?.from || l.folders[0]?.state?.contact?.phone || "";
        return l.name.toLowerCase().includes(search) || phone.toLowerCase().includes(search);
      });

      const total = allLeads.length;
      const active = allLeads.filter(l => {
        const s = l.latest_state?.next_state || "";
        const v = s.toLowerCase();
        return !(v.includes("dead") || v.includes("not_interested") || v.includes("no_time"));
      }).length;

      document.getElementById("summary").innerHTML =
        "<div><strong>" + total + "</strong> leads</div>" +
        "<div><strong>" + active + "</strong> active</div>" +
        "<div><strong>" + rows.length + "</strong> shown</div>";

      let html = "<table><thead><tr>";
      html += "<th>Name</th><th>State</th><th>Folders</th><th>Open</th>";
      html += "</tr></thead><tbody>";

      rows.forEach(l => {
        const s = l.latest_state?.next_state || "";
        const cls = stateBadgeClass(s);
        html += "<tr>";
        html += "<td>" + l.name + "</td>";
        html += "<td><span class='badge " + cls + "'>" + s + "</span></td>";
        html += "<td>" + l.folders.length + "</td>";
        html += "<td><a class='link' href='lead.html?name=" + encodeURIComponent(l.name) + "'>View</a></td>";
        html += "</tr>";
      });

      html += "</tbody></table>";

      document.getElementById("tableWrap").innerHTML = html;
    }

    async function load() {
      try {
        const res = await fetch(BACKEND + "/all");
        const data = await res.json();
        allLeads = Object.values(data);
        render();
      } catch (error) {
        document.getElementById("tableWrap").innerHTML = "<div style='color: #fecaca; padding: 20px;'>Error loading leads. Make sure BACKEND URL is set correctly.</div>";
      }
    }

    // Cards view functions
    async function loadCards() {
      try {
        const typeFilter = document.getElementById("cardTypeFilter").value;
        const stateFilter = document.getElementById("cardStateFilter").value;
        
        let url = `${BACKEND}/cards?limit=1000`;
        if (typeFilter) url += `&type=${encodeURIComponent(typeFilter)}`;
        if (stateFilter) url += `&sales_state=${encodeURIComponent(stateFilter)}`;
        
        const res = await fetch(url);
        const data = await res.json();
        allCards = data.cards || [];
        renderCards();
      } catch (error) {
        document.getElementById("cardTableWrap").innerHTML = `<div style='color: #fecaca; padding: 20px;'>Error loading cards: ${error.message}</div>`;
      }
    }

    function renderCards() {
      const search = document.getElementById("cardSearch").value.toLowerCase();
      
      let rows = allCards.filter(card => {
        if (!search) return true;
        const name = card.card_data?.name || '';
        const id = card.id || '';
        return name.toLowerCase().includes(search) || id.toLowerCase().includes(search);
      });

      // Sort by updated_at desc
      rows.sort((a, b) => {
        const aTime = a.updated_at || '';
        const bTime = b.updated_at || '';
        return bTime.localeCompare(aTime);
      });

      const total = allCards.length;
      const shown = rows.length;

      document.getElementById("cardSummary").innerHTML =
        `<div><strong>${total}</strong> cards</div>` +
        `<div><strong>${shown}</strong> shown</div>`;

      let html = "<table><thead><tr>";
      html += "<th>Name</th><th>Type</th><th>Sales State</th><th>Owner</th><th>Updated</th><th>View</th>";
      html += "</tr></thead><tbody>";

      rows.forEach(card => {
        const name = card.card_data?.name || card.id;
        const type = card.type || 'person';
        const salesState = card.sales_state || 'cold';
        const owner = card.owner || '-';
        const updated = card.updated_at ? new Date(card.updated_at).toLocaleDateString() : '-';
        
        html += "<tr>";
        html += `<td>${name}</td>`;
        html += `<td><span class='badge ${type}'>${type}</span></td>`;
        html += `<td><span class='badge gray'>${salesState}</span></td>`;
        html += `<td>${owner}</td>`;
        html += `<td>${updated}</td>`;
        html += `<td><a class='link' href='card.html?id=${encodeURIComponent(card.id)}'>View</a></td>`;
        html += "</tr>";
      });

      html += "</tbody></table>";
      document.getElementById("cardTableWrap").innerHTML = html;
    }

    // Tab switching
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        const view = tab.getAttribute("data-view");
        currentView = view;
        
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        
        document.getElementById("leadsView").style.display = view === "leads" ? "block" : "none";
        document.getElementById("cardsView").style.display = view === "cards" ? "block" : "none";
        
        if (view === "cards") {
          loadCards();
        }
      });
    });

    document.getElementById("search").addEventListener("input", render);
    document.getElementById("stateFilter").addEventListener("change", render);
    document.getElementById("cardSearch").addEventListener("input", renderCards);
    document.getElementById("cardTypeFilter").addEventListener("change", loadCards);
    document.getElementById("cardStateFilter").addEventListener("change", loadCards);

    document.querySelectorAll(".pill").forEach(p => {
      p.addEventListener("click", () => {
        document.querySelectorAll(".pill").forEach(x => x.classList.remove("active"));
        p.classList.add("active");
        currentSort = p.getAttribute("data-sort");
        render();
      });
    });

    load();
    // Auto-refresh every 30 seconds
    setInterval(() => {
      if (currentView === "leads") {
        load();
      } else {
        loadCards();
      }
    }, 30000);
  </script>
</body>
</html>
