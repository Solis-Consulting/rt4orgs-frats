<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>RT4 Lead Console</title>
  <style>
    body { font-family: -apple-system, system-ui, sans-serif; margin: 0; background: #0f172a; color: #e5e7eb; }
    .shell { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    .card { background: #020617; border-radius: 16px; padding: 20px 24px; box-shadow: 0 18px 60px rgba(0,0,0,0.6); border: 1px solid #1f2937; }
    h1 { margin: 0 0 8px; font-size: 24px; }
    .sub { margin-bottom: 16px; color: #9ca3af; font-size: 14px; }
    .toolbar { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
    input, select { background: #020617; border: 1px solid #4b5563; border-radius: 8px; padding: 6px 10px; color: #e5e7eb; font-size: 13px; }
    input:focus, select:focus { outline: none; border-color: #38bdf8; }
    .pill-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .pill { font-size: 11px; padding: 4px 10px; border-radius: 999px; border: 1px solid #374151; cursor: pointer; color: #9ca3af; }
    .pill.active { background: #0ea5e9; border-color: #0ea5e9; color: #0f172a; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 8px; }
    th, td { padding: 8px 6px; text-align: left; border-bottom: 1px solid #1f2937; }
    th { font-size: 11px; text-transform: uppercase; letter-spacing: 0.06em; color: #6b7280; }
    tr:hover td { background: #020617; }
    .badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 999px; font-size: 11px; }
    .badge.green { background: rgba(34,197,94,0.15); color: #bbf7d0; }
    .badge.red { background: rgba(248,113,113,0.15); color: #fecaca; }
    .badge.amber { background: rgba(245,158,11,0.15); color: #fed7aa; }
    .badge.gray { background: rgba(75,85,99,0.4); color: #e5e7eb; }
    .badge.person { background: rgba(59,130,246,0.15); color: #bfdbfe; }
    .badge.fraternity { background: rgba(168,85,247,0.15); color: #e9d5ff; }
    .badge.team { background: rgba(34,197,94,0.15); color: #bbf7d0; }
    .badge.business { background: rgba(245,158,11,0.15); color: #fed7aa; }
    .link { color: #38bdf8; text-decoration: none; font-weight: 500; }
    .link:hover { text-decoration: underline; }
    .meta { display: flex; gap: 16px; font-size: 12px; color: #9ca3af; margin-bottom: 8px; }
    .meta strong { color: #e5e7eb; }
    .tabs { display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 1px solid #1f2937; }
    .tab { padding: 8px 16px; cursor: pointer; color: #9ca3af; border-bottom: 2px solid transparent; }
    .tab.active { color: #38bdf8; border-bottom-color: #38bdf8; }
    button { background: #0ea5e9; color: #0f172a; border: none; border-radius: 8px; padding: 6px 12px; font-size: 13px; font-weight: 600; cursor: pointer; }
    button:hover { background: #38bdf8; }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card">
      <h1>RT4 Lead Console</h1>
      <div class="sub">Live state view of all current conversations and cards.</div>

      <div class="tabs">
        <div class="tab active" data-view="leads">Leads</div>
        <div class="tab" data-view="cards">Cards</div>
        <div style="flex: 1;"></div>
        <a href="upload.html" class="link" style="padding: 8px 0;">Upload Cards</a>
        <a href="markov_responses.html" class="link" style="padding: 8px 0; margin-left: 16px;">Response Editor</a>
      </div>

      <!-- Leads View -->
      <div id="leadsView">
        <div class="toolbar">
          <input id="search" placeholder="Search by name or phone">
          <select id="stateFilter">
            <option value="all">All states</option>
            <option value="active">Active (not dead/not_interested/no_time)</option>
            <option value="initial_outreach">Initial outreach only</option>
          </select>
        </div>

      <div class="pill-row">
        <div class="pill active" data-sort="state">Sort by state</div>
        <div class="pill" data-sort="name">Sort by name</div>
        <div class="pill" data-sort="folders_desc">Sort by folders</div>
      </div>

        <div class="meta" id="summary"></div>
        <div id="tableWrap"></div>
      </div>

      <!-- Cards View -->
      <div id="cardsView" style="display: none;">
        <div class="toolbar">
          <input id="cardSearch" placeholder="Search by name or ID">
          <select id="cardTypeFilter">
            <option value="">All types</option>
            <option value="person">Person</option>
            <option value="fraternity">Fraternity</option>
            <option value="team">Team</option>
            <option value="business">Business</option>
          </select>
          <select id="cardStateFilter">
            <option value="">All sales states</option>
            <option value="cold">Cold</option>
            <option value="qualified">Qualified</option>
            <option value="negotiating">Negotiating</option>
            <option value="won">Won</option>
            <option value="lost">Lost</option>
          </select>
          <button id="blastSelectedBtn" disabled>Run Blast on Selected Cards</button>
          <button id="deleteSelectedBtn" disabled style="background: #ef4444; margin-left: 8px;">Delete Selected Cards</button>
          <input id="authToken" type="password" placeholder="Auth Token (optional)" style="width: 180px; margin-left: 8px;">
        </div>
        <div class="meta" id="cardSummary"></div>
        <div id="cardTableWrap"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { BACKEND_URL } from '/config.js';
    const BACKEND = BACKEND_URL;
    let allLeads = [];
    let allCards = [];
    let currentSort = "state";
    let currentView = "leads";

    function stateBadgeClass(s) {
      if (!s) return "gray";
      const v = s.toLowerCase();
      if (v.includes("ready") || v.includes("pay")) return "green";
      if (v.includes("dead") || v.includes("not_interested") || v.includes("no_time")) return "red";
      if (v.includes("question") || v.includes("who_are_you") || v.includes("waiting")) return "amber";
      if (v.includes("initial_outreach")) return "gray";
      return "amber";
    }

    function sortLeads(leads, mode) {
      if (mode === "name") {
        leads.sort((a, b) => a.name.localeCompare(b.name));
      } else if (mode === "folders_desc") {
        leads.sort((a, b) => b.folders.length - a.folders.length);
      } else {
        leads.sort((a, b) => {
          const s1 = a.latest_state?.next_state || "";
          const s2 = b.latest_state?.next_state || "";
          if (s1 === "initial_outreach" && s2 !== "initial_outreach") return 1;
          if (s2 === "initial_outreach" && s1 !== "initial_outreach") return -1;
          return s1 < s2 ? 1 : -1;
        });
      }
    }

    function render() {
      const search = document.getElementById("search").value.toLowerCase();
      const filter = document.getElementById("stateFilter").value;

      let rows = allLeads.slice();

      sortLeads(rows, currentSort);

      rows = rows.filter(l => {
        const s = l.latest_state?.next_state || "";
        if (filter === "active") {
          const v = s.toLowerCase();
          if (v.includes("dead") || v.includes("not_interested") || v.includes("no_time") || v.includes("initial_outreach")) return false;
        }
        if (filter === "initial_outreach" && s !== "initial_outreach") return false;
        if (!search) return true;
        const phone = l.folders[0]?.state?.raw?.from || l.folders[0]?.state?.contact?.phone || "";
        return l.name.toLowerCase().includes(search) || phone.toLowerCase().includes(search);
      });

      const total = allLeads.length;
      const active = allLeads.filter(l => {
        const s = l.latest_state?.next_state || "";
        const v = s.toLowerCase();
        return !(v.includes("dead") || v.includes("not_interested") || v.includes("no_time"));
      }).length;

      document.getElementById("summary").innerHTML =
        "<div><strong>" + total + "</strong> leads</div>" +
        "<div><strong>" + active + "</strong> active</div>" +
        "<div><strong>" + rows.length + "</strong> shown</div>";

      let html = "<table><thead><tr>";
      html += "<th>Name</th><th>State</th><th>Messages</th><th>Open</th>";
      html += "</tr></thead><tbody>";

      rows.forEach(l => {
        const s = l.latest_state?.next_state || "";
        const cls = stateBadgeClass(s);
        const inboundCount = l.inbound_count || 0;
        html += "<tr>";
        html += "<td>" + l.name + "</td>";
        html += "<td><span class='badge " + cls + "'>" + s + "</span></td>";
        html += "<td>" + inboundCount + " message" + (inboundCount !== 1 ? "s" : "") + "</td>";
        // Link to card detail page instead of lead.html
        const cardId = l.card_id || "";
        if (cardId) {
          html += "<td><a class='link' href='card.html?id=" + encodeURIComponent(cardId) + "'>View</a></td>";
        } else {
          html += "<td>-</td>";
        }
        html += "</tr>";
      });

      html += "</tbody></table>";

      document.getElementById("tableWrap").innerHTML = html;
    }

    async function load() {
      try {
        const res = await fetch(BACKEND + "/leads");
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const data = await res.json();
        // Convert leads array to format expected by render function
        allLeads = (data.leads || []).map(lead => ({
          name: lead.name,
          card_id: lead.card_id,
          phone: lead.phone,
          latest_state: {
            next_state: lead.state || "unknown"
          },
          folders: [], // Not used in new system
          last_inbound_at: lead.last_inbound_at,
          last_outbound_at: lead.last_outbound_at,
          inbound_count: lead.inbound_count || 0,
          sales_state: lead.sales_state
        }));
        render();
      } catch (error) {
        console.error("Error loading leads:", error);
        document.getElementById("tableWrap").innerHTML = `<div style='color: #fecaca; padding: 20px;'>Error loading leads: ${error.message}. Make sure BACKEND URL is set correctly.</div>`;
      }
    }

    // Load saved auth token from localStorage on page load
    function loadSavedAuthToken() {
      const savedToken = localStorage.getItem("blastAuthToken");
      if (savedToken) {
        const authTokenInput = document.getElementById("authToken");
        if (authTokenInput) {
          authTokenInput.value = savedToken;
        }
      }
    }

    // Cards view functions
    async function loadCards() {
      try {
        const typeFilter = document.getElementById("cardTypeFilter").value;
        const stateFilter = document.getElementById("cardStateFilter").value;
        
        let url = `${BACKEND}/cards?limit=10000`;
        if (typeFilter) url += `&type=${encodeURIComponent(typeFilter)}`;
        if (stateFilter) url += `&sales_state=${encodeURIComponent(stateFilter)}`;
        
        const res = await fetch(url);
        const data = await res.json();
        allCards = data.cards || [];
        renderCards();
      } catch (error) {
        document.getElementById("cardTableWrap").innerHTML = `<div style='color: #fecaca; padding: 20px;'>Error loading cards: ${error.message}</div>`;
      }
    }

    function getSelectedCardIds() {
      const checkboxes = document.querySelectorAll('.card-select-checkbox:checked');
      return Array.from(checkboxes).map(cb => cb.getAttribute('data-id'));
    }

    function renderCards() {
      const search = document.getElementById("cardSearch").value.toLowerCase();
      
      let rows = allCards.filter(card => {
        if (!search) return true;
        const name = card.card_data?.name || '';
        const id = card.id || '';
        return name.toLowerCase().includes(search) || id.toLowerCase().includes(search);
      });

      // Sort by updated_at desc
      rows.sort((a, b) => {
        const aTime = a.updated_at || '';
        const bTime = b.updated_at || '';
        return bTime.localeCompare(aTime);
      });

      const total = allCards.length;
      const shown = rows.length;

      document.getElementById("cardSummary").innerHTML =
        `<div><strong>${total}</strong> cards</div>` +
        `<div><strong>${shown}</strong> shown</div>`;

      let html = "<table><thead><tr>";
      html += "<th><input type='checkbox' id='selectAllCheckbox' title='Select all cards'></th><th>Name</th><th>Type</th><th>Sales State</th><th>Owner</th><th>Updated</th><th>Actions</th>";
      html += "</tr></thead><tbody>";

      rows.forEach(card => {
        const name = card.card_data?.name || card.id;
        const type = card.type || 'person';
        const salesState = card.sales_state || 'cold';
        const owner = card.owner || '-';
        const updated = card.updated_at ? new Date(card.updated_at).toLocaleDateString() : '-';
        
        html += "<tr>";
        html += `<td><input type="checkbox" class="card-select-checkbox" data-id="${card.id}"></td>`;
        html += `<td>${name}</td>`;
        html += `<td><span class='badge ${type}'>${type}</span></td>`;
        html += `<td><span class='badge gray'>${salesState}</span></td>`;
        html += `<td>${owner}</td>`;
        html += `<td>${updated}</td>`;
        html += `<td><a class='link' href='card.html?id=${encodeURIComponent(card.id)}' style='margin-right: 8px;'>View</a>`;
        html += `<a class='link' href='#' onclick='assignCard("${card.id}"); return false;' style='margin-right: 8px;'>Assign</a>`;
        html += `<a class='link' href='#' onclick='deleteCard("${card.id}"); return false;' style='color: #fecaca;'>Delete</a></td>`;
        html += "</tr>";
      });

      html += "</tbody></table>";
      document.getElementById("cardTableWrap").innerHTML = html;

      // Select all checkbox functionality
      const selectAllCheckbox = document.getElementById("selectAllCheckbox");
      const cardCheckboxes = document.querySelectorAll(".card-select-checkbox");
      
      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener("change", (e) => {
          const isChecked = e.target.checked;
          cardCheckboxes.forEach(cb => {
            cb.checked = isChecked;
          });
          updateBlastButtonState();
        });
      }

      // Update select all checkbox state when individual checkboxes change
      const updateSelectAllState = () => {
        if (selectAllCheckbox && cardCheckboxes.length > 0) {
          const allChecked = Array.from(cardCheckboxes).every(cb => cb.checked);
          const someChecked = Array.from(cardCheckboxes).some(cb => cb.checked);
          selectAllCheckbox.checked = allChecked;
          selectAllCheckbox.indeterminate = someChecked && !allChecked;
        }
      };

      // Enable/disable buttons based on selection
      const blastBtn = document.getElementById("blastSelectedBtn");
      const deleteBtn = document.getElementById("deleteSelectedBtn");
      const updateBlastButtonState = () => {
        const anySelected = getSelectedCardIds().length > 0;
        blastBtn.disabled = !anySelected;
        if (deleteBtn) {
          deleteBtn.disabled = !anySelected;
        }
        updateSelectAllState();
      };
      
      cardCheckboxes.forEach(cb => {
        cb.addEventListener("change", updateBlastButtonState);
      });
      updateBlastButtonState();
    }

    async function runBlastOnSelectedCards() {
      const selectedIds = getSelectedCardIds();
      if (selectedIds.length === 0) {
        alert("No cards selected");
        return;
      }

      if (!confirm(`Run blast on ${selectedIds.length} card(s)?`)) {
        return;
      }

      const blastBtn = document.getElementById("blastSelectedBtn");
      blastBtn.disabled = true;
      blastBtn.textContent = "Blasting...";

      // Get auth token from input and save to localStorage
      const authTokenInput = document.getElementById("authToken");
      const authToken = authTokenInput ? authTokenInput.value.trim() : "";
      if (authToken) {
        localStorage.setItem("blastAuthToken", authToken);
      }

      // Build headers with auth token if available
      const headers = { "Content-Type": "application/json" };
      const storedToken = localStorage.getItem("blastAuthToken");
      const tokenToUse = authToken || storedToken || null;
      
      console.log("[BLAST] Auth token from input:", authToken ? "***" : "empty");
      console.log("[BLAST] Auth token from storage:", storedToken ? "***" : "empty");
      console.log("[BLAST] Token to use:", tokenToUse ? "***" : "none");
      
      if (tokenToUse) {
        headers["Authorization"] = `Bearer ${tokenToUse}`;
      }

      // Build payload - only include auth_token if we have one
      const payload = {
        card_ids: selectedIds,
        limit: selectedIds.length,
        owner: "system",
        source: "cards_ui"
      };
      if (tokenToUse) {
        payload.auth_token = tokenToUse;
      }

      try {
        const res = await fetch(`${BACKEND}/blast/run`, {
          method: "POST",
          headers: headers,
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (!res.ok || !data.ok) {
          const msg = data.error || `HTTP ${res.status}`;
          alert(`Blast failed: ${msg}`);
          return;
        }

        alert(`Blast complete.\nSent: ${data.sent}\nSkipped: ${data.skipped}`);
      } catch (error) {
        alert(`Blast error: ${error.message}`);
      } finally {
        blastBtn.disabled = false;
        blastBtn.textContent = "Run Blast on Selected Cards";
      }
    }

    // Tab switching
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        const view = tab.getAttribute("data-view");
        currentView = view;
        
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        
        document.getElementById("leadsView").style.display = view === "leads" ? "block" : "none";
        document.getElementById("cardsView").style.display = view === "cards" ? "block" : "none";
        
        if (view === "cards") {
          loadCards();
          loadSavedAuthToken();
        }
      });
    });

    document.getElementById("search").addEventListener("input", render);
    document.getElementById("stateFilter").addEventListener("change", render);
    async function deleteCard(cardId) {
      if (!confirm(`Delete card "${cardId}"? This will also delete related conversations and relationships.`)) {
        return;
      }

      try {
        const res = await fetch(`${BACKEND}/cards/${encodeURIComponent(cardId)}`, {
          method: "DELETE",
        });

        if (!res.ok) {
          const data = await res.json();
          alert(`Delete failed: ${data.detail || res.status}`);
          return;
        }

        alert("Card deleted successfully");
        loadCards(); // Refresh the list
      } catch (error) {
        alert(`Delete error: ${error.message}`);
      }
    }

    // Expose deleteCard to global scope for inline onclick
    window.deleteCard = deleteCard;
    
    async function assignCard(cardId) {
      // Get list of users for assignment
      const apiToken = localStorage.getItem('apiToken');
      if (!apiToken) {
        alert('Please login as admin to assign cards');
        window.location.href = 'login.html';
        return;
      }
      
      try {
        const res = await fetch(`${BACKEND}/admin/users`, {
          headers: {
            'Authorization': `Bearer ${apiToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (res.status === 401 || res.status === 403) {
          alert('Admin access required');
          return;
        }
        
        const data = await res.json();
        const users = data.users || [];
        
        if (users.length === 0) {
          alert('No users found. Create a user first in the admin dashboard.');
          return;
        }
        
        const userOptions = users.map(u => `${u.id}:${u.username}`).join('\n');
        const selection = prompt(`Assign card to user:\n\n${users.map((u, i) => `${i + 1}. ${u.username} (${u.id})`).join('\n')}\n\nEnter username or ID:`);
        
        if (!selection) return;
        
        // Find user by username or ID
        const user = users.find(u => u.username.toLowerCase() === selection.toLowerCase() || u.id.toLowerCase() === selection.toLowerCase());
        if (!user) {
          alert('User not found');
          return;
        }
        
        const notes = prompt('Assignment notes (optional):') || null;
        
        const assignRes = await fetch(`${BACKEND}/admin/assignments`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            card_id: cardId,
            user_id: user.id,
            notes: notes
          })
        });
        
        const assignData = await assignRes.json();
        if (assignData.ok) {
          alert(`Card assigned to ${user.username} successfully`);
          loadCards();
        } else {
          alert(`Failed to assign: ${assignData.detail || 'Unknown error'}`);
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }
    
    window.assignCard = assignCard;

    document.getElementById("cardSearch").addEventListener("input", renderCards);
    document.getElementById("cardTypeFilter").addEventListener("change", loadCards);
    document.getElementById("cardStateFilter").addEventListener("change", loadCards);
    document.getElementById("blastSelectedBtn").addEventListener("click", runBlastOnSelectedCards);
    
    async function deleteSelectedCards() {
      const selectedIds = getSelectedCardIds();
      if (selectedIds.length === 0) {
        alert("No cards selected");
        return;
      }

      const count = selectedIds.length;
      if (!confirm(`Delete ${count} card(s)? This will also delete related conversations and relationships. This action cannot be undone.`)) {
        return;
      }

      const deleteBtn = document.getElementById("deleteSelectedBtn");
      deleteBtn.disabled = true;
      deleteBtn.textContent = "Deleting...";

      try {
        let successCount = 0;
        let failCount = 0;
        const errors = [];

        // Delete cards one by one (could be optimized with a bulk endpoint)
        for (const cardId of selectedIds) {
          try {
            const res = await fetch(`${BACKEND}/cards/${encodeURIComponent(cardId)}`, {
              method: "DELETE",
            });

            if (!res.ok) {
              const data = await res.json();
              errors.push(`${cardId}: ${data.detail || res.status}`);
              failCount++;
            } else {
              successCount++;
            }
          } catch (error) {
            errors.push(`${cardId}: ${error.message}`);
            failCount++;
          }
        }

        if (failCount > 0) {
          alert(`Delete completed with errors.\n\nDeleted: ${successCount}\nFailed: ${failCount}\n\nErrors:\n${errors.slice(0, 5).join('\n')}${errors.length > 5 ? '\n...' : ''}`);
        } else {
          alert(`Successfully deleted ${successCount} card(s).`);
        }

        // Refresh the list
        loadCards();
      } catch (error) {
        alert(`Delete error: ${error.message}`);
      } finally {
        deleteBtn.disabled = false;
        deleteBtn.textContent = "Delete Selected Cards";
      }
    }

    document.getElementById("deleteSelectedBtn").addEventListener("click", deleteSelectedCards);

    document.querySelectorAll(".pill").forEach(p => {
      p.addEventListener("click", () => {
        document.querySelectorAll(".pill").forEach(x => x.classList.remove("active"));
        p.classList.add("active");
        currentSort = p.getAttribute("data-sort");
        render();
      });
    });

    load();
    // Load saved auth token on initial page load
    loadSavedAuthToken();
    // Auto-refresh every 30 seconds
    setInterval(() => {
      if (currentView === "leads") {
        load();
      } else {
        loadCards();
      }
    }, 30000);
  </script>
</body>
</html>
