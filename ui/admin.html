<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>RT4 Admin Dashboard</title>
  <style>
    body { font-family: -apple-system, system-ui, sans-serif; margin: 0; background: #0f172a; color: #e5e7eb; }
    .shell { max-width: 1400px; margin: 32px auto; padding: 0 16px; }
    .card { background: #020617; border-radius: 16px; padding: 20px 24px; box-shadow: 0 18px 60px rgba(0,0,0,0.6); border: 1px solid #1f2937; margin-bottom: 24px; }
    h1 { margin: 0 0 8px; font-size: 24px; }
    .sub { margin-bottom: 16px; color: #9ca3af; font-size: 14px; }
    .toolbar { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
    input, select, textarea { background: #020617; border: 1px solid #4b5563; border-radius: 8px; padding: 6px 10px; color: #e5e7eb; font-size: 13px; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #38bdf8; }
    button { background: #0ea5e9; color: #0f172a; border: none; border-radius: 8px; padding: 6px 12px; font-size: 13px; font-weight: 600; cursor: pointer; }
    button:hover { background: #38bdf8; }
    button:disabled { background: #4b5563; cursor: not-allowed; }
    button.danger { background: #ef4444; }
    button.danger:hover { background: #dc2626; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 8px; }
    th, td { padding: 8px 6px; text-align: left; border-bottom: 1px solid #1f2937; }
    th { font-size: 11px; text-transform: uppercase; letter-spacing: 0.06em; color: #6b7280; }
    tr:hover td { background: #020617; }
    .badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 999px; font-size: 11px; }
    .badge.green { background: rgba(34,197,94,0.15); color: #bbf7d0; }
    .badge.red { background: rgba(248,113,113,0.15); color: #fecaca; }
    .badge.amber { background: rgba(245,158,11,0.15); color: #fed7aa; }
    .badge.gray { background: rgba(75,85,99,0.4); color: #e5e7eb; }
    .link { color: #38bdf8; text-decoration: none; font-weight: 500; cursor: pointer; }
    .link:hover { text-decoration: underline; }
    .tabs { display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 1px solid #1f2937; }
    .tab { padding: 8px 16px; cursor: pointer; color: #9ca3af; border-bottom: 2px solid transparent; }
    .tab.active { color: #38bdf8; border-bottom-color: #38bdf8; }
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: #020617; border: 1px solid #1f2937; border-radius: 16px; padding: 24px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-header { margin-bottom: 16px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 6px; font-size: 13px; color: #9ca3af; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; box-sizing: border-box; }
    .header-actions { display: flex; gap: 12px; align-items: center; margin-left: auto; }
    .token-display { background: #1e293b; padding: 12px; border-radius: 8px; font-family: monospace; font-size: 12px; word-break: break-all; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card">
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <div>
          <h1>RT4 Admin Dashboard</h1>
          <div class="sub">Manage users and card assignments</div>
        </div>
        <div class="header-actions">
          <a href="index.html" class="link">Main Console</a>
          <a href="#" class="link" onclick="logout(); return false;">Logout</a>
        </div>
      </div>

      <!-- Owner API Token Prompt (shown on load for Blast view) -->
      <div id="ownerTokenPrompt" style="display: none; margin-top: 24px; padding: 20px; background: #1e293b; border-radius: 8px; border: 1px solid #374151;">
        <div style="margin-bottom: 12px; font-weight: 600; color: #fecaca;">‚ö†Ô∏è Owner API Token Required</div>
        <div style="margin-bottom: 12px; font-size: 12px; color: #9ca3af;">The Blast view requires owner API token for security. Enter your owner API token to continue.</div>
        <div style="display: flex; gap: 8px; align-items: center;">
          <input type="password" id="ownerApiToken" placeholder="Owner API Token" style="flex: 1; padding: 8px 12px; background: #020617; border: 1px solid #4b5563; border-radius: 8px; color: #e5e7eb; font-size: 14px;" autofocus>
          <button id="ownerTokenSubmitBtn" style="padding: 8px 16px;">Continue</button>
        </div>
        <div id="ownerTokenError" style="margin-top: 8px; color: #fecaca; font-size: 12px; display: none;"></div>
      </div>

      <div class="tabs">
        <div class="tab active" data-view="users">Users</div>
        <div class="tab" data-view="assignments">Card Assignments</div>
        <div class="tab" data-view="blast">Blast</div>
      </div>

      <!-- Users View -->
      <div id="usersView">
        <div class="toolbar">
          <button onclick="showCreateUserModal()">Create New Rep</button>
        </div>
        <div id="usersTableWrap"></div>
      </div>

      <!-- Assignments View -->
      <div id="assignmentsView" style="display: none;">
        <div class="toolbar">
          <input id="assignSearch" placeholder="Search cards...">
          <select id="assignUserFilter">
            <option value="">All users</option>
          </select>
          <select id="assignStatusFilter">
            <option value="">All statuses</option>
            <option value="assigned">Assigned</option>
            <option value="active">Active</option>
            <option value="closed">Closed</option>
            <option value="lost">Lost</option>
          </select>
          <button onclick="showAssignCardModal()">Assign Card</button>
        </div>
        <div id="assignmentsTableWrap"></div>
      </div>

      <!-- Blast View -->
      <div id="blastView" style="display: none;">
        <div class="toolbar">
          <input id="blastCardSearch" placeholder="Search cards...">
          <select id="blastTypeFilter">
            <option value="">All types</option>
            <option value="person">Person</option>
            <option value="fraternity">Fraternity</option>
            <option value="team">Team</option>
            <option value="business">Business</option>
          </select>
          <select id="blastStateFilter">
            <option value="">All sales states</option>
            <option value="cold">Cold</option>
            <option value="qualified">Qualified</option>
            <option value="negotiating">Negotiating</option>
            <option value="won">Won</option>
            <option value="lost">Lost</option>
          </select>
          <button id="ownerBlastBtn" disabled>Blast Selected Cards</button>
        </div>
        <div id="blastCardsTableWrap"></div>
      </div>
    </div>
  </div>

  <!-- Create User Modal -->
  <div id="createUserModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create New User</h2>
      </div>
      <form id="createUserForm">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="newUsername" required>
        </div>
        <div class="form-group">
          <label>Role</label>
          <select id="newRole">
            <option value="rep">Rep</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div style="padding: 12px; background: #1e293b; border-radius: 8px; margin-bottom: 16px; font-size: 12px; color: #9ca3af;">
          <strong style="color: #38bdf8;">‚ÑπÔ∏è Messaging Configuration:</strong><br>
          All messages are sent via the system Messaging Service using phone number (919) 443-6288.<br>
          No individual Twilio configuration needed - handled automatically behind the scenes.
        </div>
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button type="submit">Create User</button>
          <button type="button" onclick="hideCreateUserModal()">Cancel</button>
        </div>
      </form>
      <div id="newUserToken" style="display: none; margin-top: 16px;">
        <div style="color: #9ca3af; font-size: 12px; margin-bottom: 8px;">API Token (save this - it won't be shown again):</div>
        <div class="token-display" id="newUserTokenValue"></div>
      </div>
    </div>
  </div>

  <!-- Assign Card Modal -->
  <div id="assignCardModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Assign Card to Rep</h2>
      </div>
      <form id="assignCardForm">
        <div class="form-group">
          <label>Card ID</label>
          <input type="text" id="assignCardId" placeholder="Enter card ID" required>
        </div>
        <div class="form-group">
          <label>Assign to User</label>
          <select id="assignUserId" required>
            <option value="">Select user...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Notes (optional)</label>
          <textarea id="assignNotes" rows="3"></textarea>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button type="submit">Assign</button>
          <button type="button" onclick="hideAssignCardModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { BACKEND_URL } from '/config.js';
    const BACKEND = BACKEND_URL;

    let currentView = 'users';
    let allUsers = [];
    let allAssignments = [];
    let apiToken = localStorage.getItem('apiToken');

    if (!apiToken) {
      window.location.href = 'login.html';
    }

    const headers = {
      'Authorization': `Bearer ${apiToken}`,
      'Content-Type': 'application/json'
    };

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const view = tab.getAttribute('data-view');
        currentView = view;
        
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        document.getElementById('usersView').style.display = view === 'users' ? 'block' : 'none';
        document.getElementById('assignmentsView').style.display = view === 'assignments' ? 'block' : 'none';
        document.getElementById('blastView').style.display = view === 'blast' ? 'block' : 'none';
        
        if (view === 'users') {
          loadUsers();
        } else if (view === 'assignments') {
          loadAssignments();
        } else if (view === 'blast') {
          loadBlastCards();
        }
      });
    });

    async function loadUsers() {
      try {
        console.log('[ADMIN] Loading users...');
        const res = await fetch(`${BACKEND}/admin/users`, { headers });
        console.log('[ADMIN] Response status:', res.status);
        
        if (res.status === 401 || res.status === 403) {
          window.location.href = 'login.html';
          return;
        }
        
        if (!res.ok) {
          const text = await res.text();
          console.error('[ADMIN] Error loading users:', text);
          alert(`Error ${res.status}: ${text}`);
          return;
        }
        
        const data = await res.json();
        console.log('[ADMIN] Users loaded:', data.users?.length || 0);
        allUsers = data.users || [];
        renderUsers();
        populateUserSelects();
      } catch (error) {
        console.error('[ADMIN] Exception loading users:', error);
        alert(`Error loading users: ${error.message}`);
      }
    }

    function renderUsers() {
      let html = '<table><thead><tr>';
      html += '<th>Username</th><th>User ID</th><th>Role</th><th>API Token Preview</th><th>Created</th><th>Actions</th>';
      html += '</tr></thead><tbody>';

      allUsers.forEach(user => {
        html += '<tr>';
        html += `<td>${user.username}</td>`;
        html += `<td style="font-family: monospace; font-size: 11px; word-break: break-all;">${user.id || '-'}</td>`;
        html += `<td><span class='badge ${user.role === 'admin' ? 'amber' : 'gray'}'>${user.role === 'admin' ? 'Owner' : 'Rep'}</span></td>`;
        // Show plaintext token for reps, "N/A (hashed)" for owner/admin
        // For reps: show full token if available, otherwise show "N/A (regenerate to show)"
        const isRep = user.role !== 'admin';
        let tokenDisplay;
        let tokenColor;
        if (user.role === 'admin') {
          tokenDisplay = 'N/A (hashed)';
          tokenColor = '#9ca3af';
        } else if (user.api_token) {
          tokenDisplay = user.api_token; // Full token for reps
          tokenColor = '#38bdf8';
        } else {
          tokenDisplay = 'N/A (regenerate to show)';
          tokenColor = '#fbbf24'; // Amber/yellow to indicate action needed
        }
        html += `<td style="font-family: monospace; font-size: ${isRep && user.api_token ? '11px' : '10px'}; color: ${tokenColor}; word-break: break-all; ${isRep && user.api_token ? 'font-weight: 500;' : ''}">${tokenDisplay}</td>`;
        html += `<td>${user.created_at ? new Date(user.created_at).toLocaleDateString() : '-'}</td>`;
        html += `<td style="display: flex; gap: 8px; align-items: center;">`;
        html += `<a class='link' href='#' onclick='regenerateUserToken("${user.id}", "${user.username.replace(/'/g, "\\'")}"); return false;'>Regenerate Token</a>`;
        html += `<span style="color: #6b7280;">|</span>`;
        html += `<a class='link' href='#' onclick='deleteUser("${user.id}", "${user.username.replace(/'/g, "\\'")}"); return false;' style="color: #ef4444;">Delete</a>`;
        html += `</td>`;
        html += '</tr>';
      });

      html += '</tbody></table>';
      document.getElementById('usersTableWrap').innerHTML = html || '<div style="padding: 20px; text-align: center; color: #9ca3af;">No users</div>';
    }

    function populateUserSelects() {
      const select = document.getElementById('assignUserId');
      const filterSelect = document.getElementById('assignUserFilter');
      
      [select, filterSelect].forEach(sel => {
        if (!sel) return;
        const currentValue = sel.value;
        sel.innerHTML = sel === filterSelect ? '<option value="">All users</option>' : '<option value="">Select user...</option>';
        
        allUsers.forEach(user => {
          const option = document.createElement('option');
          option.value = user.id;
          option.textContent = user.username;
          sel.appendChild(option);
        });
        
        if (currentValue) sel.value = currentValue;
      });
    }

    function showCreateUserModal() {
      console.log('üî• BUTTON CLICKED: showCreateUserModal');
      document.getElementById('createUserModal').classList.add('show');
      document.getElementById('createUserForm').reset();
      document.getElementById('newUserToken').style.display = 'none';
    }

    function hideCreateUserModal() {
      console.log('üî• BUTTON CLICKED: hideCreateUserModal');
      document.getElementById('createUserModal').classList.remove('show');
    }

    // Expose to window for inline onclick handlers
    window.showCreateUserModal = showCreateUserModal;
    window.hideCreateUserModal = hideCreateUserModal;

    document.getElementById('createUserForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      console.log('üî• FORM SUBMIT: createUserForm');
      
      const role = document.getElementById('newRole').value;
      
      // All users get random API tokens - no Twilio SID needed
      // All messaging goes through system Messaging Service
      const payload = {
        username: document.getElementById('newUsername').value.trim(),
        role: role,
        twilio_phone_number: null,  // Not used - system phone via Messaging Service
        twilio_account_sid: null,   // Not used - system Account SID via env vars
        twilio_auth_token: null,    // Not used - system Auth Token via env vars
      };

      console.log('üî• ABOUT TO FETCH /admin/users', payload);
      console.log('üî• Headers:', headers);
      console.log('üî• BACKEND URL:', BACKEND);

      try {
        console.log('[ADMIN] Creating user:', payload);
        console.log('üî• FETCHING /admin/users');
        const res = await fetch(`${BACKEND}/admin/users`, {
          method: 'POST',
          headers,
          body: JSON.stringify(payload)
        });

        console.log('[ADMIN] Response status:', res.status);
        
        if (!res.ok) {
          const text = await res.text();
          console.error('[ADMIN] Error response:', text);
          alert(`Error ${res.status}: ${text}`);
          return;
        }

        const data = await res.json();
        console.log('[ADMIN] Response data:', data);
        
        if (data.ok && data.user) {
          // Show token prominently
          const tokenValue = data.user.api_token;
          const isRep = data.user.role === 'rep';
          
          document.getElementById('newUserTokenValue').textContent = tokenValue;
          document.getElementById('newUserToken').style.display = 'block';
          
          // Copy token to clipboard automatically
          navigator.clipboard.writeText(tokenValue).then(() => {
            console.log('[ADMIN] Token copied to clipboard');
          }).catch(err => {
            console.log('[ADMIN] Could not copy to clipboard:', err);
          });
          
          // Show appropriate message
          if (isRep) {
            alert(`Rep created! API Token (copied to clipboard):\n\n${tokenValue}\n\nSave this token - it's the rep's login key!\n\nAll messages will be sent via system Messaging Service.`);
          } else {
            alert(`Owner created! API Token (copied to clipboard):\n\n${tokenValue}\n\nSave this token - it's the owner's login key!`);
          }
          
          // Reload users after a delay
          setTimeout(() => {
            loadUsers();
            hideCreateUserModal();
          }, 2000);
        } else {
          alert(`Failed to create user: ${data.detail || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('[ADMIN] Exception:', error);
        alert(`Error: ${error.message}`);
      }
    });

    function showAssignCardModal() {
      console.log('üî• BUTTON CLICKED: showAssignCardModal');
      document.getElementById('assignCardModal').classList.add('show');
      document.getElementById('assignCardForm').reset();
    }

    function hideAssignCardModal() {
      console.log('üî• BUTTON CLICKED: hideAssignCardModal');
      document.getElementById('assignCardModal').classList.remove('show');
    }

    // Expose to window for inline onclick handlers
    window.showAssignCardModal = showAssignCardModal;
    window.hideAssignCardModal = hideAssignCardModal;

    document.getElementById('assignCardForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      console.log('üî• FORM SUBMIT: assignCardForm');
      
      const payload = {
        card_id: document.getElementById('assignCardId').value.trim(),
        user_id: document.getElementById('assignUserId').value,
        notes: document.getElementById('assignNotes').value.trim() || null,
      };

      console.log('üî• ABOUT TO FETCH /admin/assignments', payload);
      console.log('üî• Headers:', headers);
      console.log('üî• BACKEND URL:', BACKEND);

      try {
        console.log('[ADMIN] Assigning card:', payload);
        console.log('üî• FETCHING /admin/assignments');
        const res = await fetch(`${BACKEND}/admin/assignments`, {
          method: 'POST',
          headers,
          body: JSON.stringify(payload)
        });

        console.log('[ADMIN] Response status:', res.status);
        
        if (!res.ok) {
          const text = await res.text();
          console.error('[ADMIN] Error response:', text);
          alert(`Error ${res.status}: ${text}`);
          return;
        }

        const data = await res.json();
        console.log('[ADMIN] Response data:', data);
        
        if (data.ok) {
          alert('Card assigned successfully');
          hideAssignCardModal();
          loadAssignments();
        } else {
          alert(`Failed to assign card: ${data.detail || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('[ADMIN] Exception:', error);
        alert(`Error: ${error.message}`);
      }
    });

    async function loadAssignments() {
      try {
        const userFilter = document.getElementById('assignUserFilter')?.value;
        const statusFilter = document.getElementById('assignStatusFilter')?.value;
        
        let url = `${BACKEND}/admin/assignments`;
        const params = [];
        if (userFilter) params.push(`user_id=${encodeURIComponent(userFilter)}`);
        if (statusFilter) params.push(`status=${encodeURIComponent(statusFilter)}`);
        if (params.length) url += '?' + params.join('&');
        
        const res = await fetch(url, { headers });
        if (res.status === 401 || res.status === 403) {
          window.location.href = 'login.html';
          return;
        }
        
        const data = await res.json();
        allAssignments = data.assignments || [];
        renderAssignments();
      } catch (error) {
        console.error('Error loading assignments:', error);
      }
    }

    function renderAssignments() {
      const search = document.getElementById('assignSearch')?.value.toLowerCase() || '';
      
      let rows = allAssignments.filter(assign => {
        if (!search) return true;
        const cardName = assign.card?.card_data?.name || '';
        const cardId = assign.card_id || '';
        const username = assign.username || '';
        return cardName.toLowerCase().includes(search) || 
               cardId.toLowerCase().includes(search) ||
               username.toLowerCase().includes(search);
      });

      let html = '<table><thead><tr>';
      html += '<th>Card Name</th><th>Card ID</th><th>Assigned To</th><th>User ID</th><th>Status</th><th>Assigned At</th><th>Notes</th><th>Actions</th>';
      html += '</tr></thead><tbody>';

      rows.forEach(assign => {
        const cardName = assign.card?.card_data?.name || assign.card_id;
        html += '<tr>';
        html += `<td>${cardName}</td>`;
        html += `<td style="font-family: monospace; font-size: 11px; word-break: break-all;">${assign.card_id || '-'}</td>`;
        html += `<td>${assign.username}</td>`;
        html += `<td style="font-family: monospace; font-size: 11px; word-break: break-all;">${assign.user_id || '-'}</td>`;
        html += `<td><span class='badge ${assign.status === 'active' ? 'green' : assign.status === 'closed' ? 'green' : assign.status === 'lost' ? 'red' : 'gray'}'>${assign.status}</span></td>`;
        html += `<td>${assign.assigned_at ? new Date(assign.assigned_at).toLocaleDateString() : '-'}</td>`;
        html += `<td>${assign.notes || '-'}</td>`;
        html += `<td style="display: flex; gap: 8px; align-items: center;">`;
        html += `<a class='link' href='#' onclick='updateAssignmentStatus("${assign.card_id}", "${assign.user_id}"); return false;'>Update Status</a>`;
        html += `<span style="color: #6b7280;">|</span>`;
        html += `<a class='link' href='#' onclick='unassignCard("${assign.card_id}", "${assign.user_id}", "${cardName.replace(/'/g, "\\'")}"); return false;' style="color: #ef4444;">Unassign</a>`;
        html += `</td>`;
        html += '</tr>';
      });

      html += '</tbody></table>';
      document.getElementById('assignmentsTableWrap').innerHTML = html || '<div style="padding: 20px; text-align: center; color: #9ca3af;">No assignments</div>';
    }

    function updateAssignmentStatus(cardId, userId) {
      console.log('üî• BUTTON CLICKED: updateAssignmentStatus', cardId, userId);
      const status = prompt('Enter new status (assigned, active, closed, lost):');
      if (!status || !['assigned', 'active', 'closed', 'lost'].includes(status)) {
        console.log('üî• updateAssignmentStatus: invalid status or cancelled');
        return;
      }

      const payload = { status };
      console.log('üî• ABOUT TO FETCH /admin/assignments/' + cardId, payload);
      console.log('üî• Headers:', headers);
      console.log('üî• BACKEND URL:', BACKEND);

      console.log('üî• FETCHING /admin/assignments/' + cardId);
      fetch(`${BACKEND}/admin/assignments/${encodeURIComponent(cardId)}`, {
        method: 'PUT',
        headers,
        body: JSON.stringify(payload)
      })
      .then(res => {
        console.log('üî• RESPONSE STATUS', res.status);
        if (!res.ok) {
          return res.text().then(text => {
            console.error('üî• Error response:', text);
            throw new Error(`HTTP ${res.status}: ${text}`);
          });
        }
        return res.json();
      })
      .then(data => {
        console.log('üî• RESPONSE DATA', data);
        if (data.ok) {
          alert('Status updated successfully');
          loadAssignments();
        } else {
          alert(`Failed: ${data.detail || 'Unknown error'}`);
        }
      })
      .catch(error => {
        console.error('üî• FETCH ERROR', error);
        alert(`Error: ${error.message}`);
      });
    }

    document.getElementById('assignSearch')?.addEventListener('input', renderAssignments);
    document.getElementById('assignUserFilter')?.addEventListener('change', loadAssignments);
    document.getElementById('assignStatusFilter')?.addEventListener('change', loadAssignments);

    // Blast functionality for owner
    let allBlastCards = [];

    async function loadBlastCards() {
      if (!ownerToken) {
        ownerTokenPrompt.style.display = 'block';
        return;
      }

      try {
        const res = await fetch(`${BACKEND}/rep/cards`, { headers: getOwnerHeaders() });
        if (res.status === 401 || res.status === 403) {
          // Owner token invalid - reset and show prompt
          ownerToken = null;
          ownerTokenInput.value = '';
          ownerTokenPrompt.style.display = 'block';
          showOwnerTokenError('Owner API token expired or invalid. Please enter again.');
          return;
        }
        
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`HTTP ${res.status}: ${text}`);
        }
        
        const data = await res.json();
        allBlastCards = data.cards || [];
        renderBlastCards();
      } catch (error) {
        console.error('Error loading cards:', error);
        if (error.message.includes('Owner API token')) {
          ownerTokenPrompt.style.display = 'block';
          showOwnerTokenError(error.message);
        } else {
          alert(`Error loading cards: ${error.message}`);
        }
      }
    }

    function renderBlastCards() {
      const search = document.getElementById('blastCardSearch')?.value.toLowerCase() || '';
      const typeFilter = document.getElementById('blastTypeFilter')?.value || '';
      const stateFilter = document.getElementById('blastStateFilter')?.value || '';
      
      let rows = allBlastCards.filter(card => {
        if (search) {
          const name = card.card_data?.name || '';
          const id = card.id || '';
          if (!name.toLowerCase().includes(search) && !id.toLowerCase().includes(search)) {
            return false;
          }
        }
        if (typeFilter && card.type !== typeFilter) return false;
        if (stateFilter && card.sales_state !== stateFilter) return false;
        return true;
      });

      let html = '<table><thead><tr>';
      html += '<th><input type="checkbox" id="blastSelectAll"></th><th>Name</th><th>Card ID</th><th>Type</th><th>Sales State</th><th>Updated</th>';
      html += '</tr></thead><tbody>';

      rows.forEach(card => {
        const name = card.card_data?.name || card.id;
        html += '<tr>';
        html += `<td><input type="checkbox" class="blast-card-checkbox" data-id="${card.id}"></td>`;
        html += `<td>${name}</td>`;
        html += `<td style="font-family: monospace; font-size: 11px; word-break: break-all;">${card.id || '-'}</td>`;
        html += `<td><span class='badge ${card.type || 'person'}'>${card.type || 'person'}</span></td>`;
        html += `<td><span class='badge gray'>${card.sales_state || 'cold'}</span></td>`;
        html += `<td>${card.updated_at ? new Date(card.updated_at).toLocaleDateString() : '-'}</td>`;
        html += '</tr>';
      });

      html += '</tbody></table>';
      document.getElementById('blastCardsTableWrap').innerHTML = html;

      // Select all checkbox
      document.getElementById('blastSelectAll')?.addEventListener('change', (e) => {
        document.querySelectorAll('.blast-card-checkbox').forEach(cb => {
          cb.checked = e.target.checked;
        });
        updateOwnerBlastButton();
      });

      document.querySelectorAll('.blast-card-checkbox').forEach(cb => {
        cb.addEventListener('change', updateOwnerBlastButton);
      });
      updateOwnerBlastButton();
    }

    function updateOwnerBlastButton() {
      const selected = document.querySelectorAll('.blast-card-checkbox:checked').length;
      document.getElementById('ownerBlastBtn').disabled = selected === 0;
    }

    document.getElementById('blastCardSearch')?.addEventListener('input', renderBlastCards);
    document.getElementById('blastTypeFilter')?.addEventListener('change', renderBlastCards);
    document.getElementById('blastStateFilter')?.addEventListener('change', renderBlastCards);

    document.getElementById('ownerBlastBtn')?.addEventListener('click', async () => {
      if (!ownerToken) {
        alert('Owner API token required. Please enter it first.');
        ownerTokenPrompt.style.display = 'block';
        ownerTokenInput.focus();
        return;
      }

      const selected = Array.from(document.querySelectorAll('.blast-card-checkbox:checked')).map(cb => cb.getAttribute('data-id'));
      if (selected.length === 0) {
        alert('No cards selected');
        return;
      }

      if (!confirm(`Blast ${selected.length} card(s)?`)) return;

      const btn = document.getElementById('ownerBlastBtn');
      btn.disabled = true;
      btn.textContent = 'Blasting...';

      try {
        const res = await fetch(`${BACKEND}/rep/blast`, {
          method: 'POST',
          headers: getOwnerHeaders(),
          body: JSON.stringify({ card_ids: selected })
        });

        const data = await res.json();
        if (data.ok) {
          alert(`Blast complete. Sent: ${data.sent}, Skipped: ${data.skipped}`);
          loadBlastCards();
        } else {
          alert(`Blast failed: ${data.error || 'Unknown error'}`);
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Blast Selected Cards';
      }
    });

    // Load initial data
    loadUsers();

    function logout() {
      console.log('üî• BUTTON CLICKED: logout');
      localStorage.removeItem('apiToken');
      window.location.href = 'login.html';
    }

    async function editUser(userId) {
      console.log('üî• BUTTON CLICKED: editUser', userId);
      const user = allUsers.find(u => u.id === userId);
      if (!user) {
        console.log('üî• editUser: user not found');
        return;
      }

      // Twilio configuration is no longer user-specific
      // All messaging goes through system Messaging Service
      alert('‚ÑπÔ∏è Twilio Configuration\n\nAll messages are sent via the system Messaging Service using phone number (919) 443-6288.\n\nNo individual user Twilio configuration is needed - this is handled automatically behind the scenes.\n\nTo regenerate the API token, use the regenerate token endpoint.');
      return;
      
      console.log('üî• ABOUT TO FETCH /admin/users/' + userId, updatePayload);
      console.log('üî• Headers:', headers);
      console.log('üî• BACKEND URL:', BACKEND);

      try {
        console.log('[ADMIN] Updating user:', userId, updatePayload);
        console.log('üî• FETCHING /admin/users/' + userId);
        const res = await fetch(`${BACKEND}/admin/users/${encodeURIComponent(userId)}`, {
          method: 'PUT',
          headers,
          body: JSON.stringify(updatePayload)
        });

        console.log('[ADMIN] Response status:', res.status);
        
        if (!res.ok) {
          const text = await res.text();
          console.error('[ADMIN] Error response:', text);
          alert(`Error ${res.status}: ${text}`);
          return;
        }

        const data = await res.json();
        console.log('[ADMIN] Response data:', data);
        
        if (data.ok) {
          alert('User updated successfully');
          loadUsers();
        } else {
          alert(`Failed: ${data.detail || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('[ADMIN] Exception:', error);
        alert(`Error: ${error.message}`);
      }
    }
    // Expose all functions to window for inline onclick handlers
    async function deleteUser(userId, username) {
      console.log('üî• BUTTON CLICKED: deleteUser', userId, username);
      
      if (!confirm(`‚ö†Ô∏è Delete user "${username}" (${userId})?\n\nThis will:\n- Delete the user account\n- Remove all card assignments for this user\n\nThis action cannot be undone.`)) {
        console.log('üî• deleteUser: cancelled');
        return;
      }

      try {
        console.log('[ADMIN] Deleting user:', userId);
        console.log('üî• FETCHING DELETE /admin/users/' + userId);
        const res = await fetch(`${BACKEND}/admin/users/${encodeURIComponent(userId)}`, {
          method: 'DELETE',
          headers
        });

        console.log('[ADMIN] Delete response status:', res.status);
        
        if (!res.ok) {
          const text = await res.text();
          console.error('[ADMIN] Error response:', text);
          alert(`Error ${res.status}: ${text}`);
          return;
        }

        const data = await res.json();
        console.log('[ADMIN] Delete response data:', data);
        
        if (data.ok) {
          alert(`User "${username}" deleted successfully`);
          loadUsers();
        } else {
          alert(`Failed to delete user: ${data.detail || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('[ADMIN] Delete exception:', error);
        alert(`Error: ${error.message}`);
      }
    }

    async function regenerateUserToken(userId, username) {
      console.log('üî• BUTTON CLICKED: regenerateUserToken', userId, username);
      
      if (!confirm(`Regenerate API token for "${username}"?\n\nThe old token will no longer work. A new token will be generated and shown once.`)) {
        console.log('üî• regenerateUserToken: cancelled');
        return;
      }

      try {
        console.log('[ADMIN] Regenerating token for user:', userId);
        console.log('üî• FETCHING POST /admin/users/' + userId + '/regenerate-token');
        const res = await fetch(`${BACKEND}/admin/users/${encodeURIComponent(userId)}/regenerate-token`, {
          method: 'POST',
          headers
        });

        console.log('[ADMIN] Regenerate token response status:', res.status);
        
        if (!res.ok) {
          const text = await res.text();
          console.error('[ADMIN] Error response:', text);
          alert(`Error ${res.status}: ${text}`);
          return;
        }

        const data = await res.json();
        console.log('[ADMIN] Regenerate token response data:', data);
        
        if (data.ok && data.api_token) {
          // Copy to clipboard
          navigator.clipboard.writeText(data.api_token).then(() => {
            console.log('[ADMIN] Token copied to clipboard');
          }).catch(err => {
            console.log('[ADMIN] Could not copy to clipboard:', err);
          });
          
          alert(`New API Token for "${username}" (copied to clipboard):\n\n${data.api_token}\n\n‚ö†Ô∏è Save this token - it will not be shown again!\n\nThe old token no longer works.`);
          loadUsers();
        } else {
          alert(`Failed to regenerate token: ${data.detail || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('[ADMIN] Regenerate token exception:', error);
        alert(`Error: ${error.message}`);
      }
    }

    window.logout = logout;
    window.editUser = editUser;
    window.deleteUser = deleteUser;
    window.regenerateUserToken = regenerateUserToken;
    window.updateAssignmentStatus = updateAssignmentStatus;

    async function unassignCard(cardId, userId, cardName) {
      if (!confirm(`Unassign "${cardName}" from ${userId}? This will remove the assignment.`)) {
        return;
      }

      try {
        console.log('[ADMIN] Unassigning card:', { cardId, userId });
        const res = await fetch(`${BACKEND}/admin/assignments/${encodeURIComponent(cardId)}/${encodeURIComponent(userId)}`, {
          method: 'DELETE',
          headers
        });

        console.log('[ADMIN] Unassign response status:', res.status);

        if (!res.ok) {
          const text = await res.text();
          console.error('[ADMIN] Error response:', text);
          alert(`Error ${res.status}: ${text}`);
          return;
        }

        const data = await res.json();
        console.log('[ADMIN] Unassign response data:', data);

        if (data.ok) {
          alert('Card unassigned successfully');
          loadAssignments();
        } else {
          alert(`Failed to unassign card: ${data.detail || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('[ADMIN] Unassign exception:', error);
        alert(`Error: ${error.message}`);
      }
    }

    window.unassignCard = unassignCard;
  </script>
</body>
</html>
