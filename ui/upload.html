<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Upload Cards - RT4 CRM</title>
  <style>
    body { font-family: -apple-system, system-ui, sans-serif; margin: 0; background: #0f172a; color: #e5e7eb; }
    .shell { max-width: 1200px; margin: 32px auto; padding: 0 16px; }
    .card { background: #020617; border-radius: 16px; padding: 20px 24px; box-shadow: 0 18px 60px rgba(0,0,0,0.6); border: 1px solid #1f2937; margin-bottom: 16px; }
    h1 { margin: 0 0 8px; font-size: 24px; }
    .sub { margin-bottom: 16px; color: #9ca3af; font-size: 14px; }
    .link { color: #38bdf8; text-decoration: none; font-weight: 500; }
    .link:hover { text-decoration: underline; }
    textarea { width: 100%; min-height: 300px; background: #020617; border: 1px solid #4b5563; border-radius: 8px; padding: 12px; color: #e5e7eb; font-family: 'Monaco', 'Courier New', monospace; font-size: 13px; }
    textarea:focus { outline: none; border-color: #38bdf8; }
    button { background: #0ea5e9; color: #0f172a; border: none; border-radius: 8px; padding: 10px 20px; font-size: 14px; font-weight: 600; cursor: pointer; margin-right: 8px; }
    button:hover { background: #38bdf8; }
    button:disabled { background: #374151; color: #6b7280; cursor: not-allowed; }
    .button-secondary { background: #374151; color: #e5e7eb; }
    .button-secondary:hover { background: #4b5563; }
    .error { background: rgba(248,113,113,0.15); border: 1px solid rgba(248,113,113,0.3); color: #fecaca; padding: 12px; border-radius: 8px; margin: 12px 0; }
    .success { background: rgba(34,197,94,0.15); border: 1px solid rgba(34,197,94,0.3); color: #bbf7d0; padding: 12px; border-radius: 8px; margin: 12px 0; }
    .info { background: rgba(59,130,246,0.15); border: 1px solid rgba(59,130,246,0.3); color: #bfdbfe; padding: 12px; border-radius: 8px; margin: 12px 0; }
    .preview { margin-top: 16px; }
    .preview-item { background: #111827; border: 1px solid #1f2937; border-radius: 8px; padding: 12px; margin-bottom: 8px; }
    .preview-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .preview-item-id { font-family: monospace; font-size: 12px; color: #9ca3af; }
    .badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 999px; font-size: 11px; margin-left: 8px; }
    .badge.person { background: rgba(59,130,246,0.15); color: #bfdbfe; }
    .badge.fraternity { background: rgba(168,85,247,0.15); color: #e9d5ff; }
    .badge.team { background: rgba(34,197,94,0.15); color: #bbf7d0; }
    .badge.business { background: rgba(245,158,11,0.15); color: #fed7aa; }
    .toolbar { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
    .stats { display: flex; gap: 16px; font-size: 12px; color: #9ca3af; margin-top: 12px; }
    .stats strong { color: #e5e7eb; }
    pre { background: #020617; border-radius: 8px; padding: 10px 12px; font-size: 11px; overflow-x: auto; border: 1px solid #111827; margin: 8px 0; }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card">
      <a href="index.html" class="link">&larr; Back to list</a>
      <h1>Upload Cards</h1>
      <div class="sub">Upload JSON cards (person, fraternity, team, business). Cards will be validated and normalized.</div>

      <div class="toolbar">
        <button id="validateBtn">Validate JSON</button>
        <button id="previewBtn">Preview Cards</button>
        <button id="uploadBtn" disabled>Upload Cards</button>
        <button id="loadExampleBtn" class="button-secondary">Load Example</button>
        <input type="file" id="fileInput" accept=".json" style="display: none;">
        <button id="loadFileBtn" class="button-secondary">Load from File</button>
      </div>

      <textarea id="jsonInput" placeholder='Paste JSON array of cards here, e.g.:
[
  {
    "type": "person",
    "name": "John Doe",
    "phone": "+1234567890",
    "email": "john@example.com",
    "fraternity": "SigChi",
    "chapter": "Alpha",
    "tags": ["rush", "decision_maker"],
    "sales_state": "cold"
  }
]'></textarea>

      <div id="status"></div>
      <div id="preview" class="preview"></div>
    </div>
  </div>

  <script type="module">
    import { BACKEND_URL } from '/config.js';
    const BACKEND = BACKEND_URL;

    // Owner-only authentication check
    (async function checkOwnerAuth() {
      const apiToken = localStorage.getItem('apiToken');
      if (!apiToken) {
        window.location.href = 'login.html';
        return;
      }

      // Verify token is owner/admin by calling admin endpoint
      try {
        const res = await fetch(`${BACKEND}/admin/users`, {
          headers: {
            'Authorization': `Bearer ${apiToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (res.status === 401 || res.status === 403) {
          localStorage.removeItem('apiToken');
          window.location.href = 'login.html';
          return;
        }

        if (!res.ok) {
          localStorage.removeItem('apiToken');
          window.location.href = 'login.html';
          return;
        }

        // Owner token validated - continue loading page
      } catch (error) {
        console.error('Auth check failed:', error);
        localStorage.removeItem('apiToken');
        window.location.href = 'login.html';
        return;
      }
    })();
    let validatedCards = [];
    let previewData = null;

    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.className = type;
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';
    }

    function hideStatus() {
      document.getElementById('status').style.display = 'none';
    }

    function validateJSON() {
      hideStatus();
      const input = document.getElementById('jsonInput').value.trim();
      
      if (!input) {
        showStatus('Please enter JSON data', 'error');
        return;
      }

      try {
        const parsed = JSON.parse(input);
        
        if (!Array.isArray(parsed)) {
          showStatus('JSON must be an array of card objects', 'error');
          return;
        }

        if (parsed.length === 0) {
          showStatus('Array is empty', 'error');
          return;
        }

        validatedCards = parsed;
        showStatus(`✓ Valid JSON: ${parsed.length} card(s)`, 'success');
        document.getElementById('uploadBtn').disabled = false;
        console.log('UPLOAD ENABLED – valid JSON parsed');
      } catch (e) {
        showStatus(`Invalid JSON: ${e.message}`, 'error');
        document.getElementById('uploadBtn').disabled = true;
      }
    }

    async function previewCards() {
      hideStatus();
      const input = document.getElementById('jsonInput').value.trim();
      
      if (!input) {
        showStatus('Please enter JSON data', 'error');
        return;
      }

      try {
        const parsed = JSON.parse(input);
        
        if (!Array.isArray(parsed)) {
          showStatus('JSON must be an array', 'error');
          return;
        }

        const previewDiv = document.getElementById('preview');
        previewDiv.innerHTML = '';

        if (parsed.length === 0) {
          showStatus('Array is empty', 'error');
          return;
        }

        let html = '<div style="margin-top: 16px;"><strong>Preview:</strong></div>';
        
        parsed.forEach((card, idx) => {
          const type = card.type || 'person';
          const id = card.id || `(will be generated: ${type}_${(card.name || 'unknown').toLowerCase().replace(/\s+/g, '_')})`;
          
          html += `<div class="preview-item">
            <div class="preview-item-header">
              <div>
                <strong>Card ${idx + 1}</strong>
                <span class="badge ${type}">${type}</span>
              </div>
              <div class="preview-item-id">${id}</div>
            </div>
            <pre>${JSON.stringify(card, null, 2)}</pre>
          </div>`;
        });

        previewDiv.innerHTML = html;
        validatedCards = parsed;
        document.getElementById('uploadBtn').disabled = false;
        showStatus(`Preview: ${parsed.length} card(s) ready to upload`, 'success');
      } catch (e) {
        showStatus(`Error: ${e.message}`, 'error');
      }
    }

    // Get headers function
    function getHeaders() {
      const apiToken = localStorage.getItem('apiToken');
      if (!apiToken) {
        window.location.href = 'login.html';
        return {};
      }
      return {
        'Authorization': `Bearer ${apiToken}`,
        'Content-Type': 'application/json'
      };
    }

    async function uploadCards() {
      const headers = getHeaders();
      if (!headers.Authorization) {
        showStatus('Please login as owner/admin', 'error');
        return;
      }
      console.log('UPLOAD CLICKED – preparing cards');

      // Always parse current textarea content so we don't depend on prior state
      const raw = document.getElementById('jsonInput').value.trim();
      if (!raw) {
        showStatus('Please enter JSON data before uploading', 'error');
        return;
      }

      let cardsToUpload;
      try {
        cardsToUpload = JSON.parse(raw);
      } catch (e) {
        showStatus(`Invalid JSON: ${e.message}`, 'error');
        return;
      }

      if (!Array.isArray(cardsToUpload) || cardsToUpload.length === 0) {
        showStatus('JSON must be a non-empty array of cards', 'error');
        return;
      }

      const uploadBtn = document.getElementById('uploadBtn');
      uploadBtn.disabled = true;
      uploadBtn.textContent = 'Uploading...';

      showStatus('Uploading cards...', 'info');

      try {
        console.log('UPLOAD: Sending request to', `${BACKEND}/cards/upload`);
        console.log('UPLOAD: Card count:', cardsToUpload.length);
        
        const response = await fetch(`${BACKEND}/cards/upload`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(cardsToUpload),
        });

        console.log('UPLOAD RESPONSE STATUS:', response.status);
        console.log('UPLOAD RESPONSE OK:', response.ok);

        // Check HTTP status code first
        if (!response.ok) {
          let errorText;
          try {
            const errorJson = await response.json();
            errorText = errorJson.error_details?.[0]?.error || errorJson.error || JSON.stringify(errorJson);
          } catch {
            errorText = await response.text() || `HTTP ${response.status}`;
          }
          console.error('UPLOAD FAILED:', response.status, errorText);
          showStatus(`Upload failed (${response.status}): ${errorText}`, 'error');
          alert(`UPLOAD FAILED: ${response.status} - ${errorText}`);
          return;
        }

        const responseText = await response.text();
        console.log('UPLOAD RESPONSE BODY:', responseText);
        
        let result;
        try {
          result = JSON.parse(responseText);
        } catch (parseError) {
          console.error('UPLOAD: Failed to parse JSON response:', parseError);
          console.error('UPLOAD: Response text was:', responseText);
          showStatus(`Upload error: Invalid JSON response from server`, 'error');
          alert(`UPLOAD ERROR: Server returned invalid JSON. Check console for details.`);
          return;
        }

        if (result.ok) {
          // Verify cards are actually in DB
          let verificationMessage = '';
          try {
            const verifyResponse = await fetch(`${BACKEND}/cards?limit=10000`);
            if (verifyResponse.ok) {
              const verifyData = await verifyResponse.json();
              const uploadedIds = result.cards.map(c => c.id);
              const foundIds = verifyData.cards.map(c => c.id);
              const missingIds = uploadedIds.filter(id => !foundIds.includes(id));
              
              if (missingIds.length > 0) {
                verificationMessage = ` ⚠️ Warning: ${missingIds.length} card(s) not found in database after upload`;
                showStatus(
                  `✓ Upload reported success but ${missingIds.length} card(s) not found in database`,
                  'error'
                );
              } else {
                verificationMessage = ' ✓ Verified in database';
                showStatus(
                  `✓ Successfully uploaded and verified ${result.stored} card(s)`,
                  'success'
                );
              }
            } else {
              verificationMessage = ' (verification failed)';
              showStatus(
                `✓ Successfully uploaded ${result.stored} card(s)${verificationMessage}`,
                'success'
              );
            }
          } catch (verifyError) {
            console.error('Verification failed:', verifyError);
            verificationMessage = ' (verification failed)';
            showStatus(
              `✓ Successfully uploaded ${result.stored} card(s)${verificationMessage}`,
              'success'
            );
          }

          if (result.error_details && result.error_details.length > 0) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.style.marginTop = '12px';
            errorDiv.innerHTML = '<strong>Errors:</strong><pre>' + JSON.stringify(result.error_details, null, 2) + '</pre>';
            document.getElementById('status').after(errorDiv);
          }

          // Show stats
          const statsDiv = document.createElement('div');
          statsDiv.className = 'stats';
          statsDiv.innerHTML = `
            <div><strong>${result.stored}</strong> stored</div>
            <div><strong>${result.errors}</strong> errors</div>
            <div><strong>${result.cards.length}</strong> total</div>
          `;
          document.getElementById('status').after(statsDiv);

          // Clear input after successful upload
          setTimeout(() => {
            document.getElementById('jsonInput').value = '';
            validatedCards = [];
            document.getElementById('preview').innerHTML = '';
          }, 3000);
        } else {
          showStatus(`Upload failed: ${result.error_details?.[0]?.error || 'Unknown error'}`, 'error');
          if (result.error_details) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.style.marginTop = '12px';
            errorDiv.innerHTML = '<strong>Error details:</strong><pre>' + JSON.stringify(result.error_details, null, 2) + '</pre>';
            document.getElementById('status').after(errorDiv);
          }
        }
      } catch (e) {
        console.error('UPLOAD EXCEPTION:', e);
        console.error('UPLOAD EXCEPTION STACK:', e.stack);
        showStatus(`Upload error: ${e.message}`, 'error');
        alert(`UPLOAD FAILED: ${e.message}\n\nCheck browser console for details.`);
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Upload Cards';
      }
    }

    function loadExample() {
      const example = [
        {
          "type": "person",
          "name": "Aidan Scheible",
          "role": "President",
          "phone": "+12489962425",
          "email": "scheibae@miamioh.edu",
          "fraternity": "SigChi",
          "chapter": "Alpha",
          "tags": ["fraternity", "rush", "decision_maker"],
          "sales_state": "cold",
          "metadata": {
            "insta": "",
            "other_social": ""
          }
        },
        {
          "id": "sigchi_alpha",
          "type": "fraternity",
          "name": "Sigma Chi – Alpha Chapter",
          "school": "Miami University",
          "members": ["aidan_scheible_sigchi_alpha"],
          "sales_state": "active_outreach",
          "owner": "david"
        }
      ];
      
      document.getElementById('jsonInput').value = JSON.stringify(example, null, 2);
      validatedCards = example;
      document.getElementById('uploadBtn').disabled = false;
      showStatus('Example loaded', 'success');
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('jsonInput').value = e.target.result;
        validateJSON();
      };
      reader.readAsText(file);
    }

    // Auto-validate on paste
    document.getElementById('jsonInput').addEventListener('paste', function() {
      setTimeout(validateJSON, 100);
    });

    // Wire up button and file handlers (no inline HTML handlers)
    document.getElementById('validateBtn').addEventListener('click', validateJSON);
    document.getElementById('previewBtn').addEventListener('click', previewCards);
    document.getElementById('uploadBtn').addEventListener('click', uploadCards);
    document.getElementById('loadExampleBtn').addEventListener('click', loadExample);
    document.getElementById('fileInput').addEventListener('change', handleFileSelect);
    document.getElementById('loadFileBtn').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });
  </script>
</body>
</html>

