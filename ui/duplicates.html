<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Duplicate Cards - RT4 Lead Console</title>
  <style>
    body { font-family: -apple-system, system-ui, sans-serif; margin: 0; background: #0f172a; color: #e5e7eb; }
    .shell { max-width: 1400px; margin: 32px auto; padding: 0 16px; }
    .card { background: #020617; border-radius: 16px; padding: 20px 24px; box-shadow: 0 18px 60px rgba(0,0,0,0.6); border: 1px solid #1f2937; }
    h1 { margin: 0 0 8px; font-size: 24px; }
    .sub { margin-bottom: 16px; color: #9ca3af; font-size: 14px; }
    .meta { display: flex; gap: 16px; font-size: 12px; color: #9ca3af; margin-bottom: 16px; }
    .meta strong { color: #e5e7eb; }
    .link { color: #38bdf8; text-decoration: none; font-weight: 500; }
    .link:hover { text-decoration: underline; }
    button { background: #0ea5e9; color: #0f172a; border: none; border-radius: 8px; padding: 8px 16px; font-size: 13px; font-weight: 600; cursor: pointer; }
    button:hover { background: #38bdf8; }
    button:disabled { background: #4b5563; cursor: not-allowed; opacity: 0.6; }
    button.danger { background: #ef4444; }
    button.danger:hover { background: #f87171; }
    .duplicate-group { margin-bottom: 24px; border: 1px solid #1f2937; border-radius: 12px; padding: 16px; background: #0f172a; }
    .group-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #1f2937; }
    .group-header h3 { margin: 0; font-size: 16px; color: #38bdf8; }
    .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 999px; font-size: 11px; font-weight: 600; }
    .badge.count { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
    .card-item { display: flex; align-items: center; gap: 16px; padding: 12px; background: #020617; border-radius: 8px; margin-bottom: 8px; border: 1px solid #1f2937; }
    .card-item:hover { background: #1e293b; }
    .card-item input[type="radio"] { cursor: pointer; }
    .card-item.selected { border-color: #0ea5e9; background: #1e3a5f; }
    .card-info { flex: 1; }
    .card-info .name { font-weight: 600; color: #e5e7eb; margin-bottom: 4px; }
    .card-info .details { font-size: 12px; color: #9ca3af; display: flex; gap: 16px; }
    .card-info .detail-item { display: flex; gap: 4px; }
    .card-actions { display: flex; gap: 8px; }
    .merge-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid #1f2937; }
    .merge-section button { margin-right: 8px; }
    .loading { text-align: center; padding: 40px; color: #9ca3af; }
    .empty { text-align: center; padding: 40px; color: #9ca3af; }
    .error { background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 8px; padding: 12px; margin-bottom: 16px; color: #fca5a5; }
    .success { background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; border-radius: 8px; padding: 12px; margin-bottom: 16px; color: #86efac; }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card">
      <h1>Duplicate Cards</h1>
      <div class="sub">Find and merge duplicate cards based on phone number</div>
      
      <div style="margin-bottom: 16px;">
        <a href="index.html" class="link">‚Üê Back to Console</a>
        <button id="refreshBtn" style="margin-left: 16px;">Refresh</button>
      </div>

      <div id="error" style="display: none;"></div>
      <div id="success" style="display: none;"></div>

      <div class="meta" id="summary" style="display: none;"></div>
      
      <div id="loading" class="loading">Loading duplicates...</div>
      <div id="empty" class="empty" style="display: none;">No duplicates found! üéâ</div>
      <div id="duplicates"></div>
    </div>
  </div>

  <script type="module">
    import { BACKEND_URL } from '/config.js';
    const BACKEND = BACKEND_URL;

    // Owner-only authentication check
    (async function checkOwnerAuth() {
      const apiToken = localStorage.getItem('apiToken');
      if (!apiToken) {
        window.location.href = 'login.html';
        return;
      }

      try {
        const res = await fetch(`${BACKEND}/admin/users`, {
          headers: {
            'Authorization': `Bearer ${apiToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (res.status === 401 || res.status === 403) {
          localStorage.removeItem('apiToken');
          window.location.href = 'login.html';
          return;
        }

        if (!res.ok) {
          localStorage.removeItem('apiToken');
          window.location.href = 'login.html';
          return;
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        localStorage.removeItem('apiToken');
        window.location.href = 'login.html';
        return;
      }
    })();

    let duplicateGroups = [];
    let selectedPrimary = {}; // group index -> card id

    function getHeaders() {
      const apiToken = localStorage.getItem('apiToken');
      return {
        'Authorization': `Bearer ${apiToken}`,
        'Content-Type': 'application/json'
      };
    }

    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = message;
      errorDiv.className = 'error';
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }

    function showSuccess(message) {
      const successDiv = document.getElementById('success');
      successDiv.textContent = message;
      successDiv.className = 'success';
      successDiv.style.display = 'block';
      setTimeout(() => {
        successDiv.style.display = 'none';
      }, 5000);
    }

    function formatCardData(card) {
      const data = card.card_data || {};
      return {
        name: data.name || card.id,
        univ: data.univ || '-',
        org: data.org || '-',
        email: data.email || '-',
        ig: data.ig || '-',
        phone: data.phone || '-'
      };
    }

    function renderDuplicates() {
      const container = document.getElementById('duplicates');
      const loading = document.getElementById('loading');
      const empty = document.getElementById('empty');
      const summary = document.getElementById('summary');

      if (duplicateGroups.length === 0) {
        loading.style.display = 'none';
        empty.style.display = 'block';
        container.innerHTML = '';
        summary.style.display = 'none';
        return;
      }

      loading.style.display = 'none';
      empty.style.display = 'none';
      summary.style.display = 'flex';
      summary.innerHTML = `
        <div><strong>${duplicateGroups.length}</strong> duplicate groups</div>
        <div><strong>${duplicateGroups.reduce((sum, g) => sum + g.count, 0)}</strong> total duplicate cards</div>
      `;

      container.innerHTML = duplicateGroups.map((group, groupIdx) => {
        const primaryId = selectedPrimary[groupIdx] || group.cards[0].id;
        
        return `
          <div class="duplicate-group" data-group="${groupIdx}">
            <div class="group-header">
              <h3>Phone: ${group.phone}</h3>
              <span class="badge count">${group.count} duplicates</span>
            </div>
            
            ${group.cards.map((card, cardIdx) => {
              const info = formatCardData(card);
              const isPrimary = card.id === primaryId;
              
              return `
                <div class="card-item ${isPrimary ? 'selected' : ''}" data-card-id="${card.id}">
                  <input 
                    type="radio" 
                    name="primary_${groupIdx}" 
                    value="${card.id}" 
                    ${isPrimary ? 'checked' : ''}
                    onchange="selectPrimary(${groupIdx}, '${card.id}')"
                  >
                  <div class="card-info">
                    <div class="name">${info.name}</div>
                    <div class="details">
                      <div class="detail-item">
                        <strong>ID:</strong> ${card.id}
                      </div>
                      <div class="detail-item">
                        <strong>Univ:</strong> ${info.univ}
                      </div>
                      <div class="detail-item">
                        <strong>Org:</strong> ${info.org}
                      </div>
                      <div class="detail-item">
                        <strong>Email:</strong> ${info.email}
                      </div>
                      <div class="detail-item">
                        <strong>IG:</strong> ${info.ig}
                      </div>
                      <div class="detail-item">
                        <strong>State:</strong> ${card.sales_state || 'cold'}
                      </div>
                    </div>
                  </div>
                  <div class="card-actions">
                    <a href="card.html?id=${card.id}" class="link" target="_blank">View</a>
                  </div>
                </div>
              `;
            }).join('')}
            
            <div class="merge-section">
              <button 
                class="danger" 
                onclick="mergeGroup(${groupIdx})"
                ${group.cards.length < 2 ? 'disabled' : ''}
              >
                Merge into Selected Card
              </button>
              <span style="color: #9ca3af; font-size: 12px; margin-left: 8px;">
                Selected card will be kept, others will be merged and deleted
              </span>
            </div>
          </div>
        `;
      }).join('');
    }

    window.selectPrimary = function(groupIdx, cardId) {
      selectedPrimary[groupIdx] = cardId;
      renderDuplicates();
    };

    window.mergeGroup = async function(groupIdx) {
      const group = duplicateGroups[groupIdx];
      const primaryId = selectedPrimary[groupIdx] || group.cards[0].id;
      const duplicateIds = group.cards.filter(c => c.id !== primaryId).map(c => c.id);

      if (duplicateIds.length === 0) {
        showError('No duplicate cards to merge');
        return;
      }

      if (!confirm(`Merge ${duplicateIds.length} duplicate card(s) into "${primaryId}"? This will delete the duplicates.`)) {
        return;
      }

      try {
        const res = await fetch(`${BACKEND}/cards/merge`, {
          method: 'POST',
          headers: getHeaders(),
          body: JSON.stringify({
            primary_card_id: primaryId,
            duplicate_card_ids: duplicateIds
          })
        });

        const data = await res.json();

        if (!res.ok) {
          showError(data.detail || 'Failed to merge cards');
          return;
        }

        showSuccess(`Successfully merged ${duplicateIds.length} card(s) into ${primaryId}`);
        
        // Reload duplicates
        setTimeout(() => {
          loadDuplicates();
        }, 1000);
      } catch (error) {
        showError(`Error: ${error.message}`);
      }
    };

    async function loadDuplicates() {
      const loading = document.getElementById('loading');
      loading.style.display = 'block';
      document.getElementById('duplicates').innerHTML = '';
      document.getElementById('summary').style.display = 'none';

      try {
        const res = await fetch(`${BACKEND}/cards/duplicates`, {
          headers: getHeaders()
        });

        if (!res.ok) {
          if (res.status === 401 || res.status === 403) {
            window.location.href = 'login.html';
            return;
          }
          throw new Error('Failed to load duplicates');
        }

        const data = await res.json();
        duplicateGroups = data.duplicate_groups || [];
        selectedPrimary = {};
        
        renderDuplicates();
      } catch (error) {
        showError(`Error loading duplicates: ${error.message}`);
        document.getElementById('loading').style.display = 'none';
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', loadDuplicates);

    // Load on page load
    loadDuplicates();
  </script>
</body>
</html>


