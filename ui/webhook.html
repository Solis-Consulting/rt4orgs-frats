<!DOCTYPE html>
<html>
<head>
  <title>Webhook Control â€“ RT4</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 600px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h2 {
      color: #333;
      margin-bottom: 30px;
    }
    .control-group {
      background: white;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 500;
      color: #555;
    }
    input[type="checkbox"] {
      margin-left: 10px;
      transform: scale(1.2);
    }
    select {
      margin-left: 10px;
      padding: 6px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background: #0056b3;
    }
    button:active {
      transform: scale(0.98);
    }
    .status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>
  <h2>Twilio Webhook Control</h2>

  <div class="control-group">
    <label>
      Enabled:
      <input type="checkbox" id="enabled">
    </label>
  </div>

  <div class="control-group">
    <label>
      Mode:
      <select id="mode">
        <option value="prod">prod</option>
        <option value="dry_run">dry_run</option>
        <option value="paused">paused</option>
      </select>
    </label>
  </div>

  <div class="control-group">
    <label>
      Log payloads:
      <input type="checkbox" id="log_payloads">
    </label>
  </div>

  <button onclick="save()">Save</button>
  <button onclick="load()" style="background: #6c757d; margin-left: 10px;">Refresh</button>

  <div id="status" class="status"></div>

  <script type="module">
    import { BACKEND_URL } from '/config.js';
    const BACKEND = BACKEND_URL;

    // Owner-only authentication check
    (async function checkOwnerAuth() {
      const apiToken = localStorage.getItem('apiToken');
      if (!apiToken) {
        window.location.href = 'login.html';
        return;
      }

      // Verify token is owner/admin by calling admin endpoint
      try {
        const res = await fetch(`${BACKEND}/admin/users`, {
          headers: {
            'Authorization': `Bearer ${apiToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (res.status === 401 || res.status === 403) {
          localStorage.removeItem('apiToken');
          window.location.href = 'login.html';
          return;
        }

        if (!res.ok) {
          localStorage.removeItem('apiToken');
          window.location.href = 'login.html';
          return;
        }

        // Owner token validated - continue loading page
      } catch (error) {
        console.error('Auth check failed:', error);
        localStorage.removeItem('apiToken');
        window.location.href = 'login.html';
        return;
      }
    })();

    const enabled = document.getElementById('enabled');
    const mode = document.getElementById('mode');
    const log_payloads = document.getElementById('log_payloads');
    const status = document.getElementById('status');

    // Get headers function
    function getHeaders() {
      const apiToken = localStorage.getItem('apiToken');
      if (!apiToken) {
        window.location.href = 'login.html';
        return {};
      }
      return {
        'Authorization': `Bearer ${apiToken}`,
        'Content-Type': 'application/json'
      };
    }

    function showStatus(message, isError = false) {
      status.textContent = message;
      status.className = 'status ' + (isError ? 'error' : 'success');
      status.style.display = 'block';
      setTimeout(() => {
        status.style.display = 'none';
      }, 3000);
    }

    async function load() {
      const headers = getHeaders();
      if (!headers.Authorization) {
        return; // Already redirected
      }

      try {
        const res = await fetch(`${BACKEND_URL}/admin/webhook/config`, { headers });
        if (res.status === 401 || res.status === 403) {
          localStorage.removeItem('apiToken');
          window.location.href = 'login.html';
          return;
        }
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const cfg = await res.json();
        enabled.checked = cfg.enabled;
        mode.value = cfg.mode;
        log_payloads.checked = cfg.log_payloads;
        showStatus('Configuration loaded');
      } catch (error) {
        showStatus('Error loading config: ' + error.message, true);
      }
    }

    async function save() {
      try {
        const res = await fetch(`${BACKEND_URL}/admin/webhook/config`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            enabled: enabled.checked,
            mode: mode.value,
            log_payloads: log_payloads.checked
          })
        });
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const result = await res.json();
        showStatus('Configuration saved successfully');
      } catch (error) {
        showStatus('Error saving config: ' + error.message, true);
      }
    }

    // Load config on page load
    load();
  </script>
</body>
</html>

